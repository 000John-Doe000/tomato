<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>Tomato & Schedule V4</title>
    <style>
        :root {
            --c1: #F9E900; --c2: #E84566; --c3: #F5A500; --c4: #F3ADCB;
            --c5: #ACDDF7; --c6: #6EC7E2; --c7: #92CB97; --c8: #3B82C4;
            --bg: #ffffff; --text: #333;
            --tab-height: 60px;
        }
        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
        body { margin: 0; font-family: -apple-system, sans-serif; background: var(--bg); color: var(--text); height: 100dvh; display: flex; flex-direction: column; overflow: hidden; }
        .tabs { display: flex; background: #fff; border-bottom: 1px solid #eee; height: var(--tab-height); z-index: 1000; }
        .tab-btn { flex: 1; border: none; background: none; font-size: 15px; color: #888; font-weight: bold; }
        .tab-btn.active { color: var(--c2); border-bottom: 3px solid var(--c2); }
        .scroll-area { flex: 1; overflow-y: auto; padding: 20px; }
        .content { display: none; }
        .content.active { display: block; }
        #timer-view { text-align: center; }
        .tomato-container { position: relative; width: min(280px, 70vw); height: min(280px, 70vw); margin: 20px auto; }
        .tomato-svg { width: 100%; height: 100%; filter: drop-shadow(0 10px 15px rgba(232,69,102,0.2)); }
        #timer-display { position: absolute; top: 55%; left: 50%; transform: translate(-50%, -50%); font-size: 48px; font-weight: bold; color: white; }
        .presets { display: flex; justify-content: center; gap: 8px; margin-bottom: 20px; }
        .btn { padding: 10px 15px; border-radius: 25px; border: none; background: #f0f0f0; font-size: 14px; }
        .manual-set { margin: 20px 0; padding: 0 20px; }
        input[type="range"] { width: 100%; height: 10px; border-radius: 5px; background: #eee; outline: none; -webkit-appearance: none; }
        input[type="range"]::-webkit-slider-thumb { -webkit-appearance: none; width: 25px; height: 25px; background: var(--c2); border-radius: 50%; }
        .btn-start { background: var(--c2); color: white; width: 160px; font-size: 18px; margin-top: 20px; padding: 15px; border-radius: 30px; font-weight: bold; }
        .timeline { position: relative; border-left: 2px solid #eee; margin-left: 50px; margin-top: 20px; height: 1250px; }
        .hour-mark { position: absolute; left: -50px; font-size: 12px; color: #999; width: 40px; text-align: right; }
        .block { position: absolute; left: 10px; right: 0; border-radius: 8px; padding: 10px; font-size: 12px; font-weight: bold; }
        .color-picker { display: flex; flex-wrap: wrap; gap: 10px; margin-bottom: 20px; justify-content: center;}
        .color-dot { width: 38px; height: 38px; border-radius: 50%; border: 3px solid transparent; }
        .color-dot.selected { border-color: #333; }
        #now-line { position: absolute; left: -5px; right: 0; border-top: 2px solid var(--c2); z-index: 10; }
    </style>
</head>
<body>
    <div class="tabs">
        <button class="tab-btn active" id="btn-timer" onclick="switchTab('timer')">タイマー</button>
        <button class="tab-btn" id="btn-schedule" onclick="switchTab('schedule')">スケジュール</button>
    </div>
    <div class="scroll-area" id="main-scroll">
        <div id="timer-view" class="content active">
            <div class="tomato-container">
                <svg class="tomato-svg" viewBox="0 0 100 100">
                    <path d="M50 15 C30 15 10 30 10 55 C10 85 30 95 50 95 C70 95 90 85 90 55 C90 30 70 15 50 15" fill="#E84566"/>
                    <path d="M50 15 Q55 5 65 10 M50 15 Q45 5 35 10 M50 15 V5" stroke="#2D5A27" stroke-width="4" fill="none" stroke-linecap="round"/>
                </svg>
                <div id="timer-display">25:00</div>
            </div>
            <div class="presets">
                <button class="btn" onclick="setTimer(30)">30分</button>
                <button class="btn" onclick="setTimer(60)">1時間</button>
                <button class="btn" onclick="setTimer(120)">2時間</button>
            </div>
            <div class="manual-set">
                <p style="font-size: 14px; color: #666;">スライダー設定: <span id="range-val">25</span>分</p>
                <input type="range" id="timer-range" min="1" max="180" value="25" oninput="manualSet(this.value)">
            </div>
            <button id="start-btn" class="btn btn-start" onclick="toggleTimer()">START</button>
        </div>
        <div id="schedule-view" class="content">
            <h3 style="text-align:center;">今日のざっくり時間割</h3>
            <div class="color-picker" id="picker"></div>
            <div style="margin-bottom: 25px; text-align: center;">
                <input type="time" id="start-t" value="09:00" style="padding:10px;"> 〜 
                <input type="time" id="end-t" value="11:00" style="padding:10px;"><br><br>
                <button class="btn" onclick="addBlock()" style="background:#333; color:white; width: 100%; padding:15px;">ブロックを追加</button>
            </div>
            <div class="timeline" id="timeline"><div id="now-line"></div></div>
        </div>
    </div>

<script>
    let timeLeft = 1500;
    let timerId = null;
    let endTime = null; // 終了予定時刻を保持
    let schedule = JSON.parse(localStorage.getItem('my_schedule_v4') || '[]');
    const colors = ['#F9E900','#E84566','#F5A500','#F3ADCB','#ACDDF7','#6EC7E2','#92CB97','#3B82C4'];
    let selectedColor = colors[0];

    function updateDisplay(seconds) {
        const s = Math.max(0, seconds); // マイナスを表示しない
        const m = Math.floor(s / 60);
        const sec = s % 60;
        document.getElementById('timer-display').textContent = `${m}:${sec.toString().padStart(2, '0')}`;
    }

    function manualSet(val) {
        setTimer(parseInt(val));
        document.getElementById('range-val').textContent = val;
    }

    function setTimer(mins) {
        stopTimer();
        timeLeft = mins * 60;
        updateDisplay(timeLeft);
    }

    function stopTimer() {
        if (timerId) clearInterval(timerId);
        timerId = null;
        endTime = null;
        document.getElementById('start-btn').textContent = 'START';
    }

    function toggleTimer() {
        if (timerId) {
            stopTimer();
        } else {
            // 通知許可の確認
            if ("Notification" in window && Notification.permission !== "granted") {
                Notification.requestPermission();
            }
            
            endTime = Date.now() + (timeLeft * 1000);
            document.getElementById('start-btn').textContent = 'STOP';
            
            timerId = setInterval(() => {
                const now = Date.now();
                const diff = Math.round((endTime - now) / 1000);
                
                if (diff <= 0) {
                    updateDisplay(0);
                    finishTimer();
                } else {
                    updateDisplay(diff);
                }
            }, 500);
        }
    }

    function finishTimer() {
        stopTimer();
        if ("Notification" in window && Notification.permission === "granted") {
            new Notification("時間です！", { body: "ポモドーロが終了しました。" });
        }
        // 音を鳴らす試み（ブラウザの制限があるためalertとセット）
        try {
            const ctx = new (window.AudioContext || window.webkitAudioContext)();
            const osc = ctx.createOscillator();
            osc.connect(ctx.destination);
            osc.start();
            osc.stop(ctx.currentTime + 1);
        } catch(e) {}
        
        setTimeout(() => alert("時間です！"), 100);
    }

    // --- Schedule (略) ---
    function initSchedule() {
        const picker = document.getElementById('picker');
        colors.forEach(c => {
            const dot = document.createElement('div');
            dot.className = 'color-dot';
            dot.style.background = c;
            dot.onclick = () => {
                selectedColor = c;
                Array.from(picker.children).forEach(d => d.classList.remove('selected'));
                dot.classList.add('selected');
            };
            picker.appendChild(dot);
        });
        picker.children[0].classList.add('selected');
        renderTimeline();
        updateNowLine();
        setInterval(updateNowLine, 60000);
    }

    function renderTimeline() {
        const tl = document.getElementById('timeline');
        tl.querySelectorAll('.hour-mark, .block').forEach(el => el.remove());
        for(let i=0; i<=24; i++) {
            const mark = document.createElement('div'); mark.className = 'hour-mark';
            mark.style.top = `${i * 50}px`; mark.textContent = `${String(i).padStart(2, '0')}:00`;
            tl.appendChild(mark);
        }
        schedule.forEach((b, idx) => {
            const startMins = timeToMins(b.start);
            const endMins = timeToMins(b.end);
            const block = document.createElement('div');
            block.className = 'block'; block.style.top = `${(startMins/60) * 50}px`;
            block.style.height = `${((endMins - startMins)/60) * 50}px`;
            block.style.background = b.color;
            block.innerHTML = `<span onclick="deleteBlock(${idx})" style="float:right; width:20px;">×</span>`;
            tl.appendChild(block);
        });
    }

    function addBlock() {
        const s = document.getElementById('start-t').value;
        const e = document.getElementById('end-t').value;
        if(s >= e) return;
        schedule.push({ start: s, end: e, color: selectedColor });
        localStorage.setItem('my_schedule_v4', JSON.stringify(schedule));
        renderTimeline();
    }

    function deleteBlock(idx) {
        schedule.splice(idx, 1);
        localStorage.setItem('my_schedule_v4', JSON.stringify(schedule));
        renderTimeline();
    }

    function updateNowLine() {
        const now = new Date();
        const mins = now.getHours() * 60 + now.getMinutes();
        document.getElementById('now-line').style.top = `${(mins/60) * 50}px`;
    }

    function timeToMins(t) {
        const [h, m] = t.split(':').map(Number);
        return h * 60 + m;
    }

    function switchTab(tab) {
        document.querySelectorAll('.content').forEach(c => c.classList.remove('active'));
        document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
        if(tab === 'timer') {
            document.getElementById('timer-view').classList.add('active');
            document.getElementById('btn-timer').classList.add('active');
        } else {
            document.getElementById('schedule-view').classList.add('active');
            document.getElementById('btn-schedule').classList.add('active');
            renderTimeline();
        }
    }
    window.onload = initSchedule;
</script>
</body>
</html>
